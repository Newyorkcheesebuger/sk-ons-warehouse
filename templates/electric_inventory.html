{% extends "base.html" %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <h3 style="color: #333; margin: 0;">ğŸš— ì „ê¸°ì°¨ ë¶€í’ˆ ì¬ê³  í˜„í™©</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            {% if is_admin %}
            <button onclick="showAddItemModal()" class="btn btn-success btn-small">
                + ë¶€í’ˆ ì¶”ê°€
            </button>
            {% endif %}
            <a href="{{ url_for('warehouse', warehouse_name=warehouse_name) }}"
               class="btn btn-secondary btn-small">
                â† ë’¤ë¡œê°€ê¸°
            </a>
        </div>
    </div>

    {% if inventory %}
    <div style="overflow-x: auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <table class="table" style="margin: 0;">
            <thead>
                <tr>
                    <th>êµ¬ë¶„</th>
                    <th>ë¶€í’ˆëª…</th>
                    <th>ìˆ˜ëŸ‰</th>
                    <th>ì…ê³ /ì¶œê³ </th>
                    <th>ìµœì¢…ìˆ˜ì •ì</th>
                    <th>ìµœì¢…ìˆ˜ì •ì¼</th>
                    <th>ì‚¬ì§„</th>
                </tr>
            </thead>
            <tbody>
                {% for item in inventory %}
                <tr>
                    <td style="font-weight: 500;">{{ item[1] }}</td>
                    <td style="font-weight: 500;">{{ item[2] }}</td>
                    <td>
                        <span style="font-size: 18px; font-weight: bold; color: #333;">
                            {{ item[3] }}
                        </span>
                        <span style="color: #666; font-size: 12px;">ê°œ</span>
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button onclick="showQuantityModal({{ item[0] }}, 'in')"
                                    class="btn btn-success btn-small" style="font-size: 12px;">
                                +ì…ê³ 
                            </button>
                            <button onclick="showQuantityModal({{ item[0] }}, 'out')"
                                    class="btn btn-danger btn-small" style="font-size: 12px;">
                                -ì¶œê³ 
                            </button>
                        </div>
                    </td>
                    <td style="font-size: 13px;">
                        {{ item[4] if item[4] else '-' }}
                    </td>
                    <td style="font-size: 12px; color: #666;">
                        {{ item[5][:16] if item[5] else '-' }}
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button onclick="showPhotoUploadModal({{ item[0] }})"
                                    class="btn btn-primary btn-small" style="font-size: 12px;">
                                + ({{ item[6] }})
                            </button>
                            {% if item[6] > 0 %}
                            <a href="{{ url_for('view_photos', item_id=item[0]) }}"
                               class="btn btn-secondary btn-small" style="font-size: 12px;">
                                ë³´ê¸°
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 60px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <p style="font-size: 18px; color: #666; margin-bottom: 20px;">ğŸ“¦</p>
        <p style="color: #666; margin-bottom: 20px;">ë“±ë¡ëœ ë¶€í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% if is_admin %}
        <button onclick="showAddItemModal()" class="btn btn-primary">
            ì²« ë²ˆì§¸ ë¶€í’ˆ ì¶”ê°€í•˜ê¸°
        </button>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- ë¶€í’ˆ ì¶”ê°€ ëª¨ë‹¬ (ê´€ë¦¬ììš©) -->
{% if is_admin %}
<div id="addItemModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>ìƒˆ ë¶€í’ˆ ì¶”ê°€</h3>
        <form method="POST" action="{{ url_for('add_inventory_item') }}">
            <input type="hidden" name="warehouse_name" value="{{ warehouse_name }}">
            <input type="hidden" name="category" value="ì „ê¸°ì°¨">

            <div class="form-group">
                <label>êµ¬ë¶„</label>
                <input type="text" name="category" value="ì „ê¸°ì°¨" readonly style="background: #f8f9fa;">
            </div>

            <div class="form-group">
                <label>ë¶€í’ˆëª…</label>
                <input type="text" name="part_name" required placeholder="ë¶€í’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>

            <div class="form-group">
                <label>ì´ˆê¸° ìˆ˜ëŸ‰</label>
                <input type="number" name="quantity" value="0" min="0" required>
            </div>

            <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
        </form>
    </div>
</div>
{% endif %}

<!-- ìˆ˜ëŸ‰ ë³€ê²½ ëª¨ë‹¬ -->
<div id="quantityModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 id="quantityModalTitle">ìˆ˜ëŸ‰ ë³€ê²½</h3>
        <form id="quantityForm">
            <div class="form-group">
                <label id="quantityLabel">ìˆ˜ëŸ‰</label>
                <input type="number" id="quantityInput" min="1" required placeholder="ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <button type="submit" class="btn btn-primary">í™•ì¸</button>
        </form>
    </div>
</div>

<!-- ì‚¬ì§„ ì—…ë¡œë“œ ëª¨ë‹¬ -->
<div id="photoUploadModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>ì‚¬ì§„ ì—…ë¡œë“œ</h3>
        <form id="photoUploadForm" enctype="multipart/form-data">
            <div class="form-group">
                <label>ì‚¬ì§„ íŒŒì¼</label>
                <input type="file" id="photoInput" name="photo" accept="image/*" required>
                <small style="color: #666; font-size: 12px;">
                    JPG, PNG, GIF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                </small>
            </div>
            <button type="submit" class="btn btn-primary">ì—…ë¡œë“œ</button>
        </form>
    </div>
</div>

<script>
let currentItemId = null;
let currentChangeType = null;

// ëª¨ë‹¬ ê´€ë¦¬
const modals = document.querySelectorAll('.modal');
const closeButtons = document.querySelectorAll('.close');

closeButtons.forEach(btn => {
    btn.onclick = function() {
        this.closest('.modal').style.display = 'none';
    }
});

window.onclick = function(event) {
    modals.forEach(modal => {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    });
}

// ë¶€í’ˆ ì¶”ê°€ ëª¨ë‹¬
{% if is_admin %}
function showAddItemModal() {
    document.getElementById('addItemModal').style.display = 'block';
}
{% endif %}

// ìˆ˜ëŸ‰ ë³€ê²½ ëª¨ë‹¬
function showQuantityModal(itemId, changeType) {
    currentItemId = itemId;
    currentChangeType = changeType;

    const modal = document.getElementById('quantityModal');
    const title = document.getElementById('quantityModalTitle');
    const label = document.getElementById('quantityLabel');

    if (changeType === 'in') {
        title.textContent = 'ì…ê³  ì²˜ë¦¬';
        label.textContent = 'ì…ê³  ìˆ˜ëŸ‰';
    } else {
        title.textContent = 'ì¶œê³  ì²˜ë¦¬';
        label.textContent = 'ì¶œê³  ìˆ˜ëŸ‰';
    }

    document.getElementById('quantityInput').value = '';
    modal.style.display = 'block';
    document.getElementById('quantityInput').focus();
}

// ìˆ˜ëŸ‰ ë³€ê²½ ì²˜ë¦¬
document.getElementById('quantityForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const quantity = parseInt(document.getElementById('quantityInput').value);

    if (!quantity || quantity <= 0) {
        alert('ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }

    fetch('/update_quantity', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            item_id: currentItemId,
            change_type: currentChangeType,
            quantity: quantity
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });

    document.getElementById('quantityModal').style.display = 'none';
});

// ì‚¬ì§„ ì—…ë¡œë“œ ëª¨ë‹¬
function showPhotoUploadModal(itemId) {
    currentItemId = itemId;
    document.getElementById('photoUploadModal').style.display = 'block';
}

// ì‚¬ì§„ ì—…ë¡œë“œ ì²˜ë¦¬
document.getElementById('photoUploadForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData();
    const photoFile = document.getElementById('photoInput').files[0];

    if (!photoFile) {
        alert('ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }

    formData.append('photo', photoFile);

    fetch(`/upload_photo/${currentItemId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });

    document.getElementById('photoUploadModal').style.display = 'none';
});
</script>

<style>
@media (max-width: 768px) {
    .table {
        font-size: 11px;
    }

    .table th, .table td {
        padding: 8px 4px;
        vertical-align: middle;
    }

    .btn-small {
        padding: 4px 8px;
        font-size: 10px;
    }
}

.table th {
    background: #f8f9fa;
    position: sticky;
    top: 0;
    z-index: 10;
}

.table tbody tr:hover {
    background: #f8f9fa;
}
</style>
{% endblock %}