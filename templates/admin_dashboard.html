{% extends "base.html" %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 10px;">
        <h3 style="color: #333; margin: 0;">👨‍💼 관리자 대시보드</h3>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-small">
            창고 관리로 이동
        </a>
    </div>

    <!-- 🆕 Supabase 연결 상태 및 마이그레이션 -->
    <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px;">
        <h4 style="color: #333; margin-bottom: 20px; display: flex; align-items: center;">
            <span style="margin-right: 10px;">🗄️</span>
            데이터베이스 관리
        </h4>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <button onclick="checkConnection()" class="admin-function-card" style="border: none; background: #e3f2fd; cursor: pointer;">
                <div class="function-icon">🔍</div>
                <div class="function-content">
                    <h5>연결 상태 확인</h5>
                    <p>데이터베이스 연결 상태 확인</p>
                </div>
            </button>

            <button onclick="migrateToSupabase()" class="admin-function-card" style="border: none; background: #e8f5e8; cursor: pointer;">
                <div class="function-icon">📤</div>
                <div class="function-content">
                    <h5>SQLite → Supabase 마이그레이션</h5>
                    <p>로컬 데이터를 Supabase로 이전</p>
                </div>
            </button>
        </div>

        <!-- 연결 상태 표시 영역 -->
        <div id="connectionStatus" style="display: none; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <div id="statusContent"></div>
        </div>
    </div>

    <!-- 사용자 승인 및 관리 -->
    <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px;">
        <h4 style="color: #333; margin-bottom: 20px; display: flex; align-items: center;">
            <span style="margin-right: 10px;">👥</span>
            사용자 승인 및 관리
        </h4>

        {% if users %}
            <div style="overflow-x: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>이름</th>
                            <th>사번</th>
                            <th>소속팀</th>
                            <th>가입일</th>
                            <th>상태</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td style="font-weight: 500;">{{ user[1] }}</td>
                            <td style="font-family: monospace; color: #0066cc;">{{ user[2] }}</td>
                            <td>
                                <span style="background: #e9ecef; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                    {{ user[3] }}
                                </span>
                            </td>
                            <td style="font-size: 12px; color: #666;">
                                {{ user[5][:10] if user[5] else '' }}
                            </td>
                            <td>
                                {% if user[4] == 1 %}
                                    <span style="color: #28a745; font-weight: bold; font-size: 12px;">✅ 승인됨</span>
                                {% else %}
                                    <span style="color: #ffc107; font-weight: bold; font-size: 12px;">⏳ 대기중</span>
                                {% endif %}
                            </td>
                            <td>
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    {% if user[4] == 0 %}
                                        <!-- 승인 대기 중인 사용자 -->
                                        <a href="{{ url_for('approve_user', user_id=user[0]) }}"
                                           class="btn btn-success btn-small"
                                           onclick="return confirm('{{ user[1] }}님을 승인하시겠습니까?')"
                                           title="사용자 승인">
                                            ✅ 승인
                                        </a>
                                        <a href="{{ url_for('delete_user', user_id=user[0]) }}"
                                           class="btn btn-danger btn-small"
                                           onclick="console.log('삭제 버튼 클릭됨 - user_id: {{ user[0] }}'); return confirm('{{ user[1] }}님을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')"
                                           title="사용자 삭제">
                                            🗑️ 삭제
                                        </a>
                                    {% else %}
                                        <!-- 이미 승인된 사용자 -->
                                        <span style="color: #28a745; font-size: 12px; margin-right: 5px;">승인완료</span>
                                        <a href="{{ url_for('delete_user', user_id=user[0]) }}"
                                           class="btn btn-danger btn-small"
                                           onclick="console.log('삭제 버튼 클릭됨 - user_id: {{ user[0] }}'); return confirm('{{ user[1] }}님을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')"
                                           title="사용자 삭제">
                                            🗑️ 삭제
                                        </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div style="text-align: center; padding: 40px; color: #666;">
                <p style="font-size: 48px; margin-bottom: 20px;">👥</p>
                <h4 style="margin-bottom: 15px;">등록된 사용자가 없습니다</h4>
                <p style="font-size: 14px;">새로운 사용자가 가입하면 여기에 표시됩니다.</p>
            </div>
        {% endif %}
    </div>

    <!-- 시스템 현황 카드 -->
    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white; border-radius: 15px; padding: 25px; text-align: center;">
            <div style="font-size: 40px; margin-bottom: 15px;">👥</div>
            <h4 style="margin-bottom: 10px; font-size: 16px;">전체 사용자</h4>
            <p style="font-size: 28px; font-weight: bold; margin: 0;">{{ users|length }}</p>
            <p style="font-size: 12px; opacity: 0.8; margin: 5px 0 0 0;">명</p>
        </div>

        <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                    color: white; border-radius: 15px; padding: 25px; text-align: center;">
            <div style="font-size: 40px; margin-bottom: 15px;">✅</div>
            <h4 style="margin-bottom: 10px; font-size: 16px;">승인된 사용자</h4>
            <p style="font-size: 28px; font-weight: bold; margin: 0;">
                {% set approved_users = users|selectattr(4, 'equalto', 1)|list %}
                {{ approved_users|length }}
            </p>
            <p style="font-size: 12px; opacity: 0.8; margin: 5px 0 0 0;">명</p>
        </div>

        <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
                    color: white; border-radius: 15px; padding: 25px; text-align: center;">
            <div style="font-size: 40px; margin-bottom: 15px;">⏳</div>
            <h4 style="margin-bottom: 10px; font-size: 16px;">승인 대기</h4>
            <p style="font-size: 28px; font-weight: bold; margin: 0;">
                {% set pending_users = users|selectattr(4, 'equalto', 0)|list %}
                {{ pending_users|length }}
            </p>
            <p style="font-size: 12px; opacity: 0.8; margin: 5px 0 0 0;">명</p>
        </div>
    </div>

    <!-- 관리자 기능 -->
    <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
        <h4 style="color: #333; margin-bottom: 20px; display: flex; align-items: center;">
            <span style="margin-right: 10px;">⚙️</span>
            관리자 기능
        </h4>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <a href="{{ url_for('warehouse', warehouse_name='보라매창고') }}"
               class="admin-function-card" style="text-decoration: none; color: inherit;">
                <div class="function-icon">📦</div>
                <div class="function-content">
                    <h5>창고 관리</h5>
                    <p>재고 및 부품 관리</p>
                </div>
            </a>

            <div class="admin-function-card disabled">
                <div class="function-icon">📈</div>
                <div class="function-content">
                    <h5>통계 분석</h5>
                    <p>준비중</p>
                </div>
            </div>

            <div class="admin-function-card disabled">
                <div class="function-icon">🔧</div>
                <div class="function-content">
                    <h5>시스템 설정</h5>
                    <p>준비중</p>
                </div>
            </div>

            <div class="admin-function-card disabled">
                <div class="function-icon">📋</div>
                <div class="function-content">
                    <h5>보고서</h5>
                    <p>준비중</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* 반응형 디자인 */
@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr 1fr !important;
    }

    .table {
        font-size: 11px;
    }

    .table th, .table td {
        padding: 8px 4px;
    }

    .btn-small {
        padding: 6px 10px;
        font-size: 11px;
    }

    .stat-card {
        padding: 20px 15px !important;
    }

    .stat-card p {
        font-size: 24px !important;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr !important;
    }

    .admin-function-card {
        padding: 15px !important;
    }
}

/* 테이블 스타일 */
.table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #dee2e6;
}

.table tbody tr {
    transition: background-color 0.2s ease;
}

.table tbody tr:hover {
    background: #f8f9fa;
}

/* 버튼 스타일 */
.btn:disabled,
.admin-function-card.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-small {
    font-size: 12px;
    padding: 6px 12px;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.btn-small:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

/* 관리자 기능 카드 */
.admin-function-card {
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.admin-function-card:hover:not(.disabled) {
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.15);
    background: white;
}

.function-icon {
    font-size: 32px;
    margin-right: 15px;
    flex-shrink: 0;
}

.function-content h5 {
    margin: 0 0 5px 0;
    font-size: 16px;
    color: #333;
}

.function-content p {
    margin: 0;
    font-size: 12px;
    color: #666;
}

/* 통계 카드 호버 효과 */
.stat-card {
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-3px);
}

/* 로딩 애니메이션 */
.btn-small:active {
    transform: scale(0.95);
}

/* 🆕 연결 상태 스타일 */
#connectionStatus.success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

#connectionStatus.error {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

#connectionStatus.warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
// 🆕 데이터베이스 연결 상태 확인
async function checkConnection() {
    const statusDiv = document.getElementById('connectionStatus');
    const statusContent = document.getElementById('statusContent');
    
    // 로딩 표시
    statusDiv.style.display = 'block';
    statusDiv.className = '';
    statusContent.innerHTML = '<span class="loading"></span>연결 상태를 확인하는 중...';
    
    try {
        const response = await fetch('/admin/check_connection');
        const result = await response.json();
        
        if (result.success) {
            statusDiv.className = result.database.includes('PostgreSQL') ? 'success' : 'warning';
            statusContent.innerHTML = `
                <h5 style="margin: 0 0 10px 0;">${result.status} ${result.database}</h5>
                <p style="margin: 0 0 5px 0;"><strong>버전:</strong> ${result.version}</p>
                <p style="margin: 0; font-size: 14px;">${result.message}</p>
            `;
        } else {
            statusDiv.className = 'error';
            statusContent.innerHTML = `
                <h5 style="margin: 0 0 10px 0;">${result.status}</h5>
                <p style="margin: 0; font-size: 14px;">${result.message}</p>
            `;
        }
    } catch (error) {
        statusDiv.className = 'error';
        statusContent.innerHTML = `
            <h5 style="margin: 0 0 10px 0;">❌ 연결 확인 실패</h5>
            <p style="margin: 0; font-size: 14px;">서버 통신 오류: ${error.message}</p>
        `;
    }
}

// 🆕 SQLite → Supabase 마이그레이션
async function migrateToSupabase() {
    if (!confirm('🚨 중요: SQLite 데이터를 Supabase로 마이그레이션하시겠습니까?\n\n이 작업은:\n✅ 기존 SQLite 데이터를 Supabase로 복사합니다\n⚠️ 중복 데이터는 자동으로 건너뜁니다\n🔄 시간이 다소 걸릴 수 있습니다\n\n계속하시겠습니까?')) {
        return;
    }
    
    const statusDiv = document.getElementById('connectionStatus');
    const statusContent = document.getElementById('statusContent');
    
    // 로딩 표시
    statusDiv.style.display = 'block';
    statusDiv.className = '';
    statusContent.innerHTML = '<span class="loading"></span>마이그레이션을 진행하는 중... 잠시만 기다려주세요.';
    
    try {
        const response = await fetch('/admin/migrate_to_supabase');
        const result = await response.json();
        
        if (result.success) {
            statusDiv.className = 'success';
            statusContent.innerHTML = `
                <h5 style="margin: 0 0 10px 0;">✅ 마이그레이션 성공!</h5>
                <p style="margin: 0; font-size: 14px; white-space: pre-line;">${result.message}</p>
                <p style="margin: 10px 0 0 0; font-size: 12px; font-weight: bold;">이제 영구 Supabase 데이터베이스를 사용합니다! 🎉</p>
            `;
            
            // 3초 후 페이지 새로고침
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            statusDiv.className = 'error';
            statusContent.innerHTML = `
                <h5 style="margin: 0 0 10px 0;">❌ 마이그레이션 실패</h5>
                <p style="margin: 0; font-size: 14px;">${result.message}</p>
                <p style="margin: 10px 0 0 0; font-size: 12px;">환경변수 SUPABASE_DB_URL이 올바르게 설정되었는지 확인해주세요.</p>
            `;
        }
    } catch (error) {
        statusDiv.className = 'error';
        statusContent.innerHTML = `
            <h5 style="margin: 0 0 10px 0;">❌ 마이그레이션 오류</h5>
            <p style="margin: 0; font-size: 14px;">서버 통신 오류: ${error.message}</p>
        `;
    }
}

// 페이지 로드 시 통계 카드 애니메이션
document.addEventListener('DOMContentLoaded', function() {
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'all 0.5s ease';

            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 50);
        }, index * 100);
    });
    
    // 🆕 페이지 로드 시 자동으로 연결 상태 확인
    setTimeout(() => {
        checkConnection();
    }, 1000);
});

// 삭제 버튼 확인
function confirmDelete(userName, userId) {
    if (confirm(`${userName}님을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`)) {
        console.log(`사용자 삭제 확인됨 - ${userName} (ID: ${userId})`);
        return true;
    }
    return false;
}
</script>
{% endblock %}
